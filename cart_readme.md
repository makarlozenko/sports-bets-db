This part of the Sports Bets DB project implements a Redis-based betting cart system that allows users to temporarily store their bets before confirming them. The cart acts as a fast and isolated storage layer between the user and the main MongoDB database. Each user has their own Redis hash, where every bet item is stored as a JSON object. The system automatically refreshes the cart’s time-to-live (TTL) on every operation, keeping it active for three days of inactivity.

When a user adds a bet through the /cart/items endpoint, it is saved in Redis together with its details: teams, date, type, stake, and betting choice. The user can then view all items in the cart, update or delete them, or clear the entire cart if needed. Once the user is ready to confirm the bets, they can perform a checkout using the /cart/checkout endpoint. At this stage, the system validates that the user exists in MongoDB and has a sufficient balance to cover the total stake. If the balance is sufficient, the system deducts the total amount, transfers all bets from Redis into the Bets collection in MongoDB, and clears the cart. If an error occurs during the transfer, the operation is rolled back automatically, restoring the original balance and removing any partially inserted bets.

The main benefits of this implementation are speed, reliability, and data integrity. Redis ensures fast access to temporary betting data, while MongoDB remains the persistent storage for finalized bets. The TTL mechanism prevents old carts from remaining indefinitely, maintaining a clean cache. The checkout process guarantees atomicity, meaning the user’s balance and bets remain synchronized even if multiple users perform concurrent operations.

The test_cart_flow.py script demonstrates the entire workflow in action. It adds two bets to a user’s cart, checks Redis to confirm that the items were saved, verifies that MongoDB is still empty before checkout, performs the checkout operation, and finally confirms that the cart has been cleared and the bets have appeared in MongoDB. This end-to-end test confirms that the cart logic, balance validation, and data synchronization between Redis and MongoDB are all functioning correctly.

